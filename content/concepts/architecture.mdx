# Architecture

Provenonce is split into three independent services. Each can be deployed, scaled, and replaced independently.

## System Overview

```
┌─────────────────────────────────────────────────────────┐
│                    AI Agent (SDK)                        │
│  @provenonce/sdk — BeatAgent class                      │
│  • Registers (with or without wallet)                   │
│  • Purchases SIGIL (identity classification)            │
│  • Sends heartbeats (paid liveness proofs)              │
│  • Verifies lineage proofs locally                      │
└──────────┬──────────────────────┬───────────────────────┘
           │ HTTPS                │ HTTPS
           ▼                      ▼
┌─────────────────────┐  ┌────────────────────────────────┐
│   Beats Service     │  │      Registry Service          │
│   beats-jet.vercel  │  │   provenonce.io/api/v1/*       │
│                     │  │                                │
│  • VDF computation  │◄─│  • Agent state (Supabase)      │
│  • Solana anchors   │  │  • Registration + wallets      │
│  • SPL Memo write   │  │  • SIGIL + heartbeat           │
│  • Stateless (no DB)│  │  • Ed25519 lineage proofs      │
│                     │  │  • Imports anchors from Beats   │
└─────────┬───────────┘  └──────────┬─────────────────────┘
          │                         │
          ▼                         ▼
┌─────────────────────┐  ┌─────────────────────┐
│   Solana (devnet)   │  │     Supabase        │
│  SPL Memo anchors   │  │  Agent state        │
│                     │  │  Anchors (verified) │
└─────────────────────┘  └─────────────────────┘
```

## Service Responsibilities

| Service | Purpose | Database | Deploys |
|---------|---------|----------|---------|
| **Beats** | VDF math + Solana anchors | None (stateless) | `beats-jet.vercel.app` |
| **Registry** | Agent identity, SIGIL, heartbeats, lineage proofs | Supabase | `provenonce.io` |
| **SDK** | Client library for agents | None | npm `@provenonce/sdk` |

Agents do not compute VDF. The Beats service computes VDF anchors on Solana; agents interact with the Registry for identity, heartbeats, and proofs.

## Agent Lifecycle

```
  Register             Purchase SIGIL          Heartbeat
  ────────►           ────────────►          ──────────►
                                             (periodic)
┌──────────┐    ┌──────────────┐    ┌──────────────────────┐
│ Unborn   │───►│ Registered   │───►│ Active               │
│          │    │ (DB record,  │    │ (SIGIL purchased,    │
│          │    │  opt. wallet)│    │  sending heartbeats) │
└──────────┘    └──────────────┘    └──────────┬───────────┘
                                               │
                                    Heartbeats lapse
                                    (no deadline, no penalty)
                                               │
                                               ▼
                                    ┌──────────────────────┐
                             Resume │ Stale                │
                           ◄────────│ (market-determined   │
                          heartbeat │  standing)           │
                                    └──────────────────────┘
```

### State Transitions

1. **Register** -- SDK creates agent identity in the database (with optional wallet)
2. **Purchase SIGIL** -- Agent selects an identity class (`narrow_task`, `autonomous`, `orchestrator`) and pays via on-chain transaction
3. **Heartbeat** -- Agent sends periodic heartbeats with payment; each heartbeat returns a fresh Ed25519-signed lineage proof (24h validity)
4. **Stale** -- If an agent stops sending heartbeats, it becomes stale. Standing is market-determined, not server-enforced. No penalty.
5. **Resume** -- A stale agent resumes by sending a new heartbeat. No resync required.

## Three-Layer Identity

Every agent has three independent identity layers:

```
┌─────────────────────────────────────────────┐
│ Layer 1: API Key (pvn_...)                  │
│ • HMAC-signed, stateless                    │
│ • Used for all API operations               │
│ • Rotatable without identity change         │
├─────────────────────────────────────────────┤
│ Layer 2: Beat Hash (0x...)                  │
│ • SHA-256 of registration data              │
│ • Immutable, defines lineage               │
│ • Parent → child chain                      │
├─────────────────────────────────────────────┤
│ Layer 3: Wallet (optional, chain-agnostic)  │
│ • No wallet (default) — identity only       │
│ • Solana self-custody (Model A, opt-in)     │
│ • Operator-provided wallet (Model B)        │
│ • Ethereum BYO (EIP-191 signature)          │
│ • Private key never sent to server          │
│ • Root agents only; children inherit parent │
└─────────────────────────────────────────────┘
```

## Data Flow: Heartbeat

```
Agent                     Registry                  Supabase
  │                          │                          │
  │ 1. POST /agent/heartbeat │                          │
  │ { payment_tx }─────────►│                          │
  │                          │ 2. Validate API key      │
  │                          │ 3. Load agent state ────►│
  │                          │◄────────────────────────│
  │                          │ 4. Verify payment_tx     │
  │                          │ 5. Get current anchor    │
  │                          │ 6. Sign lineage proof    │
  │                          │    (Ed25519, 24h expiry) │
  │                          │ 7. Update heartbeat ───►│
  │                          │◄────────────────────────│
  │◄── 8. { lineage_proof }  │                          │
```

## Data Flow: Lineage Proof Verification

Lineage proofs are Ed25519-signed and can be verified offline:

```
Agent / Verifier                      Registry
  │                                      │
  │ GET /.well-known/                    │
  │     provenonce-authority.json ──────►│
  │◄── { public_key_hex } ──────────────│
  │                                      │
  │ Provenonce.verifyProofLocally(       │
  │   proof, public_key_hex             │
  │ )                                    │
  │ → true/false (no server needed)      │
```

## Anchor Chain

The Beats service writes a new global anchor to Solana every minute. The Registry imports these anchors into Supabase. Heartbeats reference the current anchor, linking agent liveness to the on-chain timeline.

```
Beats Cron (every 1 min)          Registry Cron (every 1 min)
        │                                   │
        ▼                                   ▼
  Read latest anchor              Fetch latest from Beats
  from Solana                     via fetchBeatsAnchor()
        │                                   │
        ▼                                   ▼
  Compute next anchor             Verify + store in
  (VDF of prev + index)           Supabase global_anchors
        │
        ▼
  Write SPL Memo
  to Solana
```
